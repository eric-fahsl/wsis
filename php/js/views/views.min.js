var app=app||{};app.FacetView=Backbone.View.extend({tagName:"li",template:_.template($("#facet-template").html()),events:{click:"facetClick"},initialize:function(){this.listenTo(this.model,"destroy",this.remove)},render:function(){this.$el.attr("id","F_"+this.model.get("term")).html(this.template(this.model.toJSON()));return this},facetClick:function(e){window.location=this.model.get("url")},setParentView:function(e){this.parentView=e}});var app=app||{};app.ReccHeaderView=Backbone.View.extend({tagName:"span",template:_.template($("#recc-date-template").html()),initialize:function(){this.listenTo(this.model,"destroy",this.remove)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});var app=app||{};app.ReccView=Backbone.View.extend({tagName:"div",className:"reccView span2",template:_.template($("#recc-template").html()),initialize:function(){this.listenTo(this.model,"destroy",this.remove)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});var app=app||{};app.SearchResultsView=Backbone.View.extend({el:"#searchContainer",recommendationsEl:"#searchResults",facetEl:"#facets",sortEl:"#search_sort",facets:{},resultsCollection:{},facetCollection:{},dateHeaderCollection:{},sortOptions:{},initialized:false,mobileFacetsShown:false,distanceFacetHeaderId:"#distanceHeader",template:_.template($("#recc-template").html()),events:{"click #toggleFilters":"toggleFilters"},init:function(){this.collection=new app.SearchResult;this.dateHeaderCollection=new app.DateList;var e=new app.ReccList;this.facetCollection={date:e,region:e,state:e,powder:e};this.sortOptions={powder:"Powder",bluebird:"Bluebird",fl:"Freezing Level"};this.sortModels={};var t=this;$(this.sortEl).change(function(){window.location=$(t.sortEl+" option:selected")[0].value})},testMethod:function(){this.facets={};this.refreshData()},refreshData:function(e){if(!this.initialized){this.init();this.initialized=true}if(e)this.facets=e;var t=this;this.collection.fetch({data:$.param(this.facets),success:function(e){t.dateHeaderCollection.clearAll();$.each(t.resultsCollection,function(e,t){t.clearAll()});t.resultsCollection={};$.each(t.facetCollection,function(e,t){t.clearAll()});$.each(t.sortModels,function(e,t){t.destroy()});t.sortModels={};t.dateHeaderCollection=new app.DateList;$.each(e.results,function(e,n){t.dateHeaderCollection.add(new app.DateModel({date:e},t.facets));t.resultsCollection[e]=new app.ReccList(n)});$.each(t.facetCollection,function(n,r){var i=e.facets[n];if(i.terms)i=i.terms;else if(i.ranges)i=i.ranges;t.facetCollection[n]=new app.FacetList(i,{facets:t.facets,facetType:n})});if(t.collection.facets.distance){t.facetCollection.distance=new app.FacetList(e.facets.distance.ranges,{facets:t.facets,facetType:"distance"});t.sortOptions.distance="Distance"}else{$(t.distanceFacetHeaderId).hide()}$.each(t.sortOptions,function(e,n){t.sortModels[e]=new app.SortOption({sort:e,displayValue:n},t.facets)});t.render()}})},render:function(){var e=this;var t=0;$.each(this.sortModels,function(t,n){var r=new app.SortView({model:n});$(e.sortEl).append(r.render().el)});$.each(this.resultsCollection,function(n,r){var i=new app.ReccHeaderView({model:e.dateHeaderCollection.models[t++]});$(e.recommendationsEl).append(i.render().el);r.each(function(t){e.renderRecc(t,n)})});$.each(this.facetCollection,function(t,n){n.each(function(n){e.renderFacet(n,t)})});$.each(this.facets,function(t,n){e.toggleFacet(n)});this.hideFacets()},renderRecc:function(e,t){var n=new app.ReccView({model:e});$(this.recommendationsEl).append(n.render().el)},renderFacet:function(e,t){if(!(t=="powder"||t=="distance")||e.attributes.total_count>0){var n=new app.FacetView({model:e});n.setParentView(this);$("#"+t+"Facets").append(n.render().el)}},dateFacetClick:function(e){this.facetClick(e,"date")},regionFacetClick:function(e){this.facetClick(e,"region")},stateFacetClick:function(e){this.facetClick(e,"state")},distanceFacetClick:function(e){this.facetClick(e,"distance")},facetClick:function(e,t){var n=e.currentTarget.id.split("_")[1];if(this.facets[t]==n)delete this.facets[t];else this.facets[t]=n;this.refreshData()},sortClick:function(e){console.log(e)},toggleFacet:function(e){var t="#F_"+e;var n="#X_"+e;$(t).addClass("selected");$(n).show()},toggleFilters:function(){if(!this.mobileFacetsShown)this.showFacets();else this.hideFacets()},hideFacets:function(){$(this.facetEl).addClass("hidden-phone");this.mobileFacetsShown=false},showFacets:function(){$(this.facetEl).removeClass("hidden-phone");this.mobileFacetsShown=true}});var app=app||{};app.SortView=Backbone.View.extend({tagName:"option",template:_.template($("#facet-sort").html()),events:{click:"sortChange"},initialize:function(){this.listenTo(this.model,"destroy",this.remove)},render:function(){this.$el.attr("selected",this.model.get("selected")).attr("value",this.model.get("url")).html(this.template(this.model.toJSON()));return this},sortChange:function(e){console.log(e);window.location=this.model.get("url")},setParentView:function(e){this.parentView=e}})