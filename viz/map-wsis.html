<!DOCTYPE html>
<html>
  <head>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="polymaps.js"></script>
    <style type="text/css">

@import url("example.css");

.layer circle {
  fill: lightgrey;
  stroke: white;
  fill-opacity: .75;
  vector-effect: non-scaling-stroke;

}

#copy {
  color: #000;
  opacity: .5;
}

#copy a {
  color: #000;
}

#title {
  position: absolute;
  right: 5px;
  top: 5px;
  color:white;

}

#start {
  position: absolute;
  left: 10px;
  bottom: 20px;  
}

#stop {
  position: absolute;
  left: 90px;
  bottom: 20px;
}

.clickable {
  color: yellow;
  padding:10px;
  border: 1px solid white;
  cursor: pointer;
  cursor: hand;
}

.titleface {
  font-style:oblique;
  font-family:Tahoma;
  padding-right:10px;
  font-size: 1.2em;
}

    </style>
  </head>
  <body id="map">
    <script type="text/javascript">
      
      var sampleData2 = (function () {
        var sampleData2 = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "allDatesData.json",
            'dataType': "json",
            'success': function (data) {
                sampleData2 = data;
            }
        });
        return sampleData2;
    })(); 
      var dayIndex = 0;

      var po = org.polymaps;
      var jsonData = null;
      var newJsonData = null;

      var map = po.map()
          .container(document.getElementById("map").appendChild(po.svg("svg")))
          .add(po.interact())
          .add(po.hash())
          .center({lat: 46.14, lon: -101.26})
          .zoom(4);

      map.add(po.image()
          .url(po.url("http://{S}tile.cloudmade.com"
          + "/9c01b06470084ec3b50e8de888a13e89" // http://cloudmade.com/register
          + "/999/256/{Z}/{X}/{Y}.png")
          .hosts(["a.", "b.", "c.", ""])));

      map.add(po.compass().pan("none"));

      var myVar;
      
      refreshData(dayIndex++);

  function startAnimation() {
    myVar=setInterval(function(){refreshData(dayIndex++)},500);
  }

  function refreshData(i) {
      if (jsonData) 
        map.remove(jsonData)
      jsonData = po.geoJson()
        .features(sampleData2[i]['features'])
        .on("load", load)
        .clip(false);
      map.add(jsonData);

      updateCaption(sampleData2[i]['date']);

      /*if (jsonData) {
        var t = setTimeout(hideLayer(jsonData), 500);
      }
      jsonData = newJsonData;
      */

  }

  function hideLayer(layer) {
     map.remove(layer);
  }

  function stopTimer() {
    clearInterval(myVar);
  }

  function updateCaption(date) {
    $("#title").text(date);
  }

  function load(e) {
    for ( var i in e.tile.element.childNodes ) {
      var el = e.tile.element.childNodes[i];
      var val = e.features[i];
      if (val && val.data) {
        count = val.data.properties.count;
        r = 3 * count;
        //if (count > 10000) r = 6;
        //else if (count > 5000) r = 4; 

        el.setAttribute("r", r);
      }
    }
  }
    
    function updateData() {
      jsonData = po.geoJson()
          //.url("wsis-sample.json")
          .features(singleDateData)
          .on("load", load)
          .clip(false)
          .reshow();
    }
/*
    var g = e.tile.element;
    while (g.lastChild) g.removeChild(g.lastChild);

    for (var i in e.features) {
      var feature = e.features[i].data;
      var point = g.appendChild(po.svg("circle"));
      point.setAttribute("cx", feature.geometry.coordinates[1]);
      point.setAttribute("cy", feature.geometry.coordinates[0]);
      point.setAttribute("r", 3);

    } */
  
    /*
    var cluster = e.tile.cluster || (e.tile.cluster = kmeans()
        .iterations(16)
        .size(64));

    for (var i = 0; i < e.features.length; i++) {
      cluster.add(e.features[i].data.geometry.coordinates);
    }

    var tile = e.tile, g = tile.element;
    while (g.lastChild) g.removeChild(g.lastChild);

    var means = cluster.means();
    means.sort(function(a, b) { return b.size - a.size; });
    for (var i = 0; i < means.length; i++) {
      var mean = means[i], point = g.appendChild(po.svg("circle"));
      point.setAttribute("cx", mean.x);
      point.setAttribute("cy", mean.y);
      point.setAttribute("r", Math.pow(2, tile.zoom - 11) * Math.sqrt(mean.size));
    } 
  } */

    </script>
    <div id="start" onclick="startAnimation();" class="clickable titleface">
      START
    </div>
    <div id="stop" onclick="stopTimer();" class="clickable titleface">
      STOP
    </div>
    
    <span id="title" class="titleface">
      
    </span>
    <span id="copy">
      &copy; 2010
      <a href="http://www.cloudmade.com/">CloudMade</a>,
      <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors,
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.
    </span>
  </body>
</html>
