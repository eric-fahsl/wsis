<!DOCTYPE html>
<html>
  <head>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="polymaps.js"></script>
    <style type="text/css">

@import url("example.css");

.layer circle {
  fill: lightgrey;
  stroke: white;
  fill-opacity: .75;
  vector-effect: non-scaling-stroke;

}

#copy {
  color: #000;
  opacity: .5;
}

#copy a {
  color: #000;
}

#title {
  position: absolute;
  right: 5px;
  top: 5px;
  color:white;

}

#start {
  position: absolute;
  left: 10px;
  bottom: 20px;  
}

#stop {
  position: absolute;
  left: 90px;
  bottom: 20px;
}

.clickable {
  cursor: pointer;
  cursor: hand;
}

.titleface {
color: yellow;
  padding:10px;
  border: 1px solid white;
  font-style:oblique;
  font-family:Tahoma;
  padding-right:10px;
  font-size: 1.2em;
}

#calendarDiv {
  font-family: Tahoma;
  color: yellow;
  position: absolute;
  right: 10px;
  bottom: 20px;
  opacity:0.7;
}

.selected {
  background: yellow;
  color: black;
}

.calendar {
    float: left;
    padding-right: 10px;
    font-size: 0.9em;
    text-align: center;
  }

  .smaller {
    font-size: 0.7em;
  }

    </style>
  </head>
  <body id="map">
    
    <div id="start" onclick="startAnimation();" class="clickable titleface">
      START
    </div>
    <div id="stop" onclick="stopTimer();" class="clickable titleface">
      STOP
    </div>
    
    <span id="title" class="titleface">
      
    </span>

    <div id="calendarDiv">
      <table class="calendar" cellspacing=0><tr><th>December</th></tr><tr><td><table class="smaller"><tr class=cl><td>Su</td><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td id='date0'>1</td></tr><tr><td id='date1'>2</td><td id='date2'>3</td><td id='date3'>4</td><td id='date4'>5</td><td id='date5'>6</td><td id='date6'>7</td><td id='date7'>8</td></tr><tr><td id='date8'>9</td><td id='date9'>10</td><td id='date10'>11</td><td id='date11'>12</td><td id='date12'>13</td><td id='date13'>14</td><td id='date14'>15</td></tr><tr><td id='date15'>16</td><td id='date16'>17</td><td id='date17'>18</td><td id='date18'>19</td><td id='date19'>20</td><td id='date20'>21</td><td id='date21'>22</td></tr><tr><td id='date22'>23</td><td id='date23'>24</td><td id='date24'>25</td><td id='date25'>26</td><td id='date26'>27</td><td id='date27'>28</td><td id='date28'>29</td></tr><tr><td id='date29'>30</td><td id='date30'>31</td><td >&nbsp;</td><td>&nbsp;</td><td >&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></table></td></tr></table>  

<table class="calendar" cellspacing=0><tr><th>January</th></tr><tr><td><table class="smaller"><tr class=cl><td>Su</td><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr><tr><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td></tr><tr><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td><td>19</td></tr><tr><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td><td>26</td></tr><tr><td>27</td><td>28</td><td>29</td><td>30</td><td>31</td><td>&nbsp;</td><td>&nbsp;</td></tr></table></td></tr></table>


<table class="calendar" cellspacing=0><tr><th>February</th></tr><tr><td><table class="smaller"><tr class=cl><td>Su</td><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>1</td><td>2</td></tr><tr><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr><tr><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td></tr><tr><td>17</td><td>18</td><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td></tr><tr><td>24</td><td>25</td><td>26</td><td>27</td><td>28</td><td>&nbsp;</td><td>&nbsp;</td></tr></table></td></tr></table>


<table class="calendar" cellspacing=0><tr><th>March</th></tr><tr><td><table class="smaller"><tr class=cl><td>Su</td><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>1</td><td>2</td></tr><tr><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr><tr><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td></tr><tr><td>17</td><td>18</td><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td></tr><tr><td>24</td><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td></tr><tr><td>31</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></table></td></tr></table>


<table class="calendar" cellspacing=0><tr><th>April</th></tr><tr><td><table class="smaller"><tr class=cl><td>Su</td><td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td></tr><tr><td>&nbsp;</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td></tr><tr><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td></tr><tr><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td></tr><tr><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td><td>26</td><td>27</td></tr><tr><td>28</td><td>29</td><td>30</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></table></td></tr></table>

    </div>
    <span id="copy">
      &copy; 2010
      <a href="http://www.cloudmade.com/">CloudMade</a>,
      <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors,
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.
    </span>

  <script type="text/javascript">
      
      var sampleData2 = (function () {
        var sampleData2 = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "allDatesData.json",
            'dataType': "json",
            'success': function (data) {
                sampleData2 = data;
            }
        });
        return sampleData2;
    })(); 
      var dayIndex = 0;

      var po = org.polymaps;
      var jsonData = null;
      var newJsonData = null;

      var map = po.map()
          .container(document.getElementById("map").appendChild(po.svg("svg")))
          .add(po.interact())
          .add(po.hash())
          .center({lat: 46.14, lon: -101.26})
          .zoom(4);

      map.add(po.image()
          .url(po.url("http://{S}tile.cloudmade.com"
          + "/9c01b06470084ec3b50e8de888a13e89" // http://cloudmade.com/register
          + "/999/256/{Z}/{X}/{Y}.png")
          .hosts(["a.", "b.", "c.", ""])));

      map.add(po.compass().pan("none"));

      var myVar;
      
      refreshData(dayIndex++);

      //set up click actions
      for (i=0; i<31; i++) {
        $('#date' + i).click(selectDate);
        $('#date' + i).addClass('clickable');
      }

  function startAnimation() {
    myVar=setInterval(function(){refreshData(dayIndex++)},500);
  }

  function refreshData(i) {
      if (jsonData) {
        map.remove(jsonData)
        unhighlightDate(i-1);
      }
      jsonData = po.geoJson()
        .features(sampleData2[i]['features'])
        .on("load", load)
        .clip(false);
      map.add(jsonData);

      $('#date' + i).addClass('selected');

      updateCaption(sampleData2[i]['date']);

      /*if (jsonData) {
        var t = setTimeout(hideLayer(jsonData), 500);
      }
      jsonData = newJsonData;
      */

  }

  function hideLayer(layer) {
     map.remove(layer);
  }

  function stopTimer() {
    clearInterval(myVar);
  }

  function updateCaption(date) {
    $("#title").text(date);
  }

  function load(e) {
    for ( var i in e.tile.element.childNodes ) {
      var el = e.tile.element.childNodes[i];
      var val = e.features[i];
      if (val && val.data) {
        count = val.data.properties.count;
        r = 3 * count;
        //if (count > 10000) r = 6;
        //else if (count > 5000) r = 4; 

        el.setAttribute("r", r);
      }
    }
  }
    
    function updateData() {
      jsonData = po.geoJson()
          //.url("wsis-sample.json")
          .features(singleDateData)
          .on("load", load)
          .clip(false)
          .reshow();
    }

    function unhighlightDate(dateIndex) {
      $('#date' + dateIndex).removeClass('selected');
    }

    function selectDate(){
      unhighlightDate(dayIndex - 1);
      elementId = this.id;
      dayIndex = elementId.substring(4);
      refreshData(dayIndex++);
    }

    </script>
  </body>
</html>
